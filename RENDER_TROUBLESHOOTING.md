# Render 502 Bad Gateway トラブルシューティング

## 🔍 現在の修正内容

### 1. Procfile の改善

```bash
web: gunicorn oshaberi_web_app:app --bind 0.0.0.0:$PORT --timeout 120 --workers 1 --threads 2
```

- `--chdir .`を削除（Render では不要）
- `--workers 1`でメモリ使用量を削減
- `--threads 2`でパフォーマンス向上

### 2. データベースパスの修正

- Render 環境で書き込み可能なディレクトリを使用
- エラーハンドリングを追加

### 3. エラーログの改善

- データベース初期化の成功/失敗をログに出力
- トレースバックを出力してデバッグしやすく

## 📝 Render ダッシュボードで確認すべきこと

### Step 1: ログを確認

1. https://dashboard.render.com にログイン
2. 「talkfridge」サービスを選択
3. **Logs**タブを開く
4. 以下のメッセージを探す：
   - `✅ データベース初期化成功`
   - `⚠️ データベース初期化エラー`
   - `🚀 Starting TalkFridge app...`
   - `Listening at: http://0.0.0.0:XXXX`

### Step 2: 環境変数を確認

**必須の環境変数：**

- `GEMINI_API_KEY` - レシピ提案機能用（オプションだが推奨）

**推奨の環境変数：**

- `FLASK_ENV=production`
- `PORT`（自動設定されるが、確認）

### Step 3: ビルドログを確認

1. **Events**タブを開く
2. 最新のデプロイを選択
3. ビルドエラーがないか確認
4. `pip install`が成功しているか確認

## 🔧 追加の対処方法

### 方法 1: 手動で再デプロイ

1. Render ダッシュボードでサービスを選択
2. 「Manual Deploy」→「Deploy latest commit」
3. デプロイの進行を確認

### 方法 2: 環境変数の再設定

1. **Environment**タブを開く
2. 既存の環境変数を確認
3. `GEMINI_API_KEY`が正しく設定されているか確認
4. 間違っていれば削除して再追加

### 方法 3: サービスを再起動

1. サービスの設定画面を開く
2. 「Restart」ボタンをクリック
3. ログで起動メッセージを確認

## 📊 期待されるログ出力

**正常な起動時：**

```
✅ データベース初期化成功: /opt/render/project/src/oshaberi_reizoko.db
ℹ️ GEMINI_API_KEYが設定されていません。レシピ提案機能は使用できません。
[INFO] Starting gunicorn 21.2.0
[INFO] Listening at: http://0.0.0.0:XXXX (XXXX)
[INFO] Using worker: sync
[INFO] Booting worker with pid: XXXX
```

**エラーが発生した場合：**
エラーメッセージが表示されるので、その内容を確認してください。

## 🆘 まだ解決しない場合

### 確認事項チェックリスト

- [ ] ログにエラーメッセージが表示されているか
- [ ] ビルドが成功しているか
- [ ] 環境変数が正しく設定されているか
- [ ] `requirements.txt`の依存関係がインストールできているか
- [ ] ポートが正しくリスニングしているか

### 次に試すこと

1. **ログのエラーメッセージを共有**してください
2. **ビルドログを確認**してください
3. **環境変数の設定を確認**してください

### 代替案

もし Render で解決しない場合、以下のサービスを検討してください：

- **Vercel**（簡単、無料）
- **Fly.io**（無料枠あり）
- **Railway**（無料枠あり、簡単）

## 💡 ヒント

Render の無料枠では：

- 15 分間アクセスがないとスピンダウンする
- 再起動に 30-60 秒かかる
- メモリ制限がある（512MB 程度）

これらの制限が問題の場合、有料プランにアップグレードするか、別のサービスを検討してください。

